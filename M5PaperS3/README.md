# EasyShortcutKey M5PaperS3

このフォルダには、M5PaperS3（e-inkディスプレイ搭載）版のEasyShortcutKeyデバイスのソースが含まれているよ。目に優しいe-inkディスプレイで長時間使用でき、超低消費電力でバッテリーが長持ち！

## システム構成
```
M5PaperS3 [e-ink Display + Touch] —[USB Keyboard]→ PC（Windows/Mac）
                ↓
        ショートカット一覧表示
         （タッチで選択）
```

## ハードウェア仕様
- **マイコン**: ESP32-S3（M5PaperS3）
- **ディスプレイ**: 4.7インチ e-ink（540×960、16階調グレースケール）
- **タッチパネル**: 静電容量式タッチスクリーン
- **通信**: USB HID Keyboard / Bluetooth Keyboard（切り替え可能）
- **ストレージ**: TFカード対応（ショートカットデータ更新用）
- **電源**: 内蔵バッテリー（超低消費電力設計）+ 電源ON/OFFボタン

## 機能要件

### ディスプレイ機能
- e-inkディスプレイでショートカット一覧を表示
- 2列または3列レイアウトで見やすく配置
- タッチしやすい大きなボタンサイズ
- バッテリー残量・接続状態表示
- 目に優しい表示（ブルーライトなし）

### タッチパネル機能
- 静電容量式タッチでショートカット選択
- タッチフィードバック表示
- スワイプでページ切り替え
- 長押しで設定メニュー表示

### 電力管理機能
- **ディープスリープ**: 非使用時は自動スリープ
- **ウェイクアップ**: タッチまたは電源ボタンで復帰
- **バッテリー監視**: 残量表示と低電力警告
- **超低消費電力**: e-inkならではの長時間動作
- **電源ボタン**: 長押しで完全シャットダウン

### データ管理機能
- **内蔵データ**: 初期ショートカット設定
- **TFカード**: 外部データファイル読み込み
- **手動更新**: TFカードを使ったデータ更新

### キーボード機能
- **デュアルモード**: USB HID / Bluetooth Keyboard切り替え対応
- **ワンタッチ切り替え**: 設定画面から簡単にモード変更
- **有線・無線対応**: USB接続時はUSB HID、無線時はBluetooth
- **電力効率**: 使用していないモードは自動停止
- **複雑なショートカットキー組み合わせ対応**
- 日本語/英語キーボードレイアウト対応
- 超低遅延キー送信

### 電源管理機能
- 電源ON/OFFボタン（長押しで完全シャットダウン）
- ディープスリープモード（タッチでウェイクアップ）
- バッテリー残量表示・低電力警告
- 自動スリープタイマー設定可能

## KeyboardGWとの違い

| 項目 | KeyboardGW (AtomS3) | M5PaperS3版 |
|------|-------------------|-------------|
| ディスプレイ | LED（状態表示のみ） | 4.7" e-ink（ショートカット一覧） |
| 入力方法 | BLE経由のみ | タッチパネルのみ |
| 通信機能 | BLE + USB HID | USB HID / Bluetooth切り替え |
| 消費電力 | 通常 | 超低消費電力 |
| 動作モード | 常時稼働 | ディープスリープ対応 |
| データ更新 | BLE + TFカード | TFカードのみ |
| 表示情報 | 接続状態のみ | ショートカット一覧 + 状態 |
| 電源管理 | USB給電のみ | バッテリー + 電源ボタン |
| バッテリー持続 | 数日 | 数週間〜数ヶ月 |

## 開発環境
- **IDE**: Arduino IDE または PlatformIO
- **ボードマネージャ**: ESP32 Arduino Core
- **必要ライブラリ**:
  - `M5EPD` (e-inkディスプレイ制御)
  - `USB HID`
  - `ESP32 BLE HID` (Bluetoothキーボード)
  - `ArduinoJson`
  - `SD` (TFカード読み込み)

## ファイル構成
```
M5PaperS3/
├── README.md              # このファイル
├── M5PaperS3.ino          # メインのArduinoスケッチ
├── Config.h               # 設定定数・構造体定義
├── DisplayHandler.h/cpp   # e-inkディスプレイ制御
├── TouchHandler.h/cpp     # タッチパネル処理
├── PowerManager.h/cpp     # 電力管理・スリープ制御
├── DataManager.h/cpp      # データ管理・TFカード読み込み
├── KeyboardHandler.h/cpp  # USBキーボード処理
├── platformio.ini         # PlatformIO設定
└── data/
    └── shortcuts.json     # 初期ショートカットデータ
```

## 画面レイアウト

### メイン画面
```
┌─────────────────────────────┐
│ EasyShortcutKey    🔋 85% │ ← ヘッダー
│ � USB Mode   [PWR] 📶     │   電源ボタン＆接続モード表示
├─────────────────────────────┤
│  [  Ctrl+C  ] [ Ctrl+V  ] │ ← ショートカットボタン
│  [  Copy    ] [ Paste   ] │   （2列レイアウト）
│                           │
│  [ Ctrl+Z ] [ Ctrl+Y ] │
│  [ Undo   ] [ Redo   ] │
│                           │
│  [ Ctrl+F ] [ Ctrl+H ] │
│  [ Find   ] [Replace] │
├─────────────────────────────┤
│ ◀ Prev [⚙️Settings] [🔄USB/BT] Next ▶ │ ← フッター（モード切替追加）
└─────────────────────────────┘
```

## 動作フロー
1. **起動**: ディスプレイ初期化、ショートカット読み込み
2. **待機**: e-ink表示でショートカット一覧表示
3. **タッチ検出**: ショートカット選択
4. **キー送信**: 対応するキー入力をPCに送信
5. **フィードバック**: タッチフィードバック表示
6. **スリープ**: 一定時間後ディープスリープ
7. **ウェイクアップ**: タッチで復帰

## TFカードデータ形式
`/shortcuts.json` ファイルをTFカードに保存:
```json
{
  "appName": "VS Code",
  "groups": [
    {
      "name": "編集",
      "shortcuts": [
        {
          "name": "コピー",
          "keys": ["ctrl", "c"],
          "description": "選択範囲をコピー"
        }
      ]
    }
  ]
}
```

## 使用方法

### 基本操作
1. **ショートカット実行**: 画面上のボタンをタッチ
2. **ページ切り替え**: 左右端をタッチまたはスワイプ
3. **設定画面**: フッター中央の設定ボタンをタッチ
4. **電源管理**:
   - 短押し: スリープ/復帰切り替え
   - 長押し(2秒以上): 完全シャットダウン

### キーボードモード切り替え
1. 設定画面を開く
2. 「Switch Keyboard Mode」ボタンをタッチ
3. USB HID ⇔ Bluetooth で切り替え
4. モード変更後は自動的に初期化される

### データ更新
1. TFカードにshortcuts.jsonファイルを配置
2. M5PaperS3を再起動
3. 自動的に外部データを読み込み

## 省電力設計
- **e-inkディスプレイ**: 電力消費ほぼゼロ（表示更新時のみ）
- **Bluetooth省電力**: 必要時のみBT接続、不使用時は無効化
- **ディープスリープ**: CPU・周辺機能停止
- **ウェイクアップソース**: タッチパネル、電源ボタン
- **自動スリープ**: 30秒間操作なしで自動移行
- **電源管理**: ハードウェア電源ボタンで完全シャットダウン
- **バッテリー持続**: 通常使用で数週間〜数ヶ月

## 設定項目
- **表示列数**: 2列/3列切り替え
- **キーボードモード**: USB HID / Bluetooth切り替え
- **スリープ時間**: 自動スリープまでの時間
- **タッチ感度**: タッチパネルの感度調整
- **ディスプレイ更新**: 高速/高品質モード切り替え
- **データソース**: 内蔵/TFカード選択
- **電源管理**: 自動シャットダウン設定

## トラブルシューティング
- **ディスプレイが更新されない**: 電源再投入、TFカード確認
- **タッチが反応しない**: 画面クリーニング、感度調整
- **バッテリーが持たない**: ディープスリープ設定確認
- **データが読めない**: TFカードフォーマット、JSONファイル確認

## 変更履歴
- 初期プロジェクト作成
- M5PaperS3対応仕様策定