[env:m5stack-atoms3]
platform = espressif32
board = m5stack-atoms3
framework = arduino

; シリアル通信設定
monitor_speed = 115200
upload_speed = 921600

; ビルド設定
build_flags = 
    -DCORE_DEBUG_LEVEL=1
    -DBOARD_HAS_PSRAM
    ; Arduino USB: デバッグ用に一時的に併用
    -DARDUINO_USB_MODE=0
    -DARDUINO_USB_CDC_ON_BOOT=0
    ; デバッグ用にUART0も有効化
    -DENABLE_UART0_DEBUG=1
    ; ESP-IDF USB Serial/JTAG完全無効化（より強力な設定）
    -DCONFIG_ESP_CONSOLE_UART_DEFAULT=1
    -DCONFIG_ESP_CONSOLE_USB_SERIAL_JTAG=0
    -DCONFIG_ESP_CONSOLE_SECONDARY_NONE=1
    -DCONFIG_ESP_CONSOLE_UART_NUM=0
    ; USB Serial/JTAG を完全に無効化
    -DCONFIG_USB_SERIAL_JTAG_ENABLED=0
    -DCONFIG_ESP32S3_USB_OTG_SUPPORTED=1
    -DCONFIG_TINYUSB_ENABLED=1
    -DCONFIG_TINYUSB_NO_DEFAULT_4_PIN=1
    ; ブートローダーレベルでもUSB Serial/JTAG無効化
    -DCONFIG_BOOTLOADER_LOG_LEVEL=0
    -DCONFIG_BOOTLOADER_LOG_LEVEL_NONE=y
    -DCONFIG_LOG_DEFAULT_LEVEL=0
    -DCONFIG_LOG_DEFAULT_LEVEL_NONE=y
    ; 完全にUSBデバッグを無効化
    -DCONFIG_ESP32S3_DEBUG_OCDAWARE=n
    -DCONFIG_ESP_SYSTEM_PANIC_PRINT_HALT=y
    ; TinyUSB強制有効化（後で使用）
    -DUSE_TINYUSB=1
    -DCFG_TUSB_OS=OPT_OS_FREERTOS
    -DCFG_TUD_ENABLED=1
    -DCFG_TUD_CDC=1
    -DCFG_TUD_HID=1
    -DCFG_TUD_ENDPOINT0_SIZE=64
    -DCFG_TUD_RHPORT0_MODE=1
    ; Custom VID/PID
    -DCONFIG_TINYUSB_DESC_CUSTOM_VID=0x303A
    -DCONFIG_TINYUSB_DESC_CUSTOM_PID=0x0002
    ; Enable custom descriptors
    -DCFG_TUD_DESCRIPTOR_STRING=1

; 必要ライブラリ - 段階的に追加
lib_deps = 
    USB@^2.0.0
    m5stack/M5AtomS3@^1.0.2
    m5stack/M5Unified@^0.2.8
    ESP32 BLE Arduino
    bblanchon/ArduinoJson@^6.21.3
    fastled/FastLED@^3.10.3

; パーティション設定
board_build.partitions = huge_app.csv
board_build.arduino.memory_type = qio_opi

; USB設定（TinyUSB Composite Device）
board_build.usb_product = "EasyShortcutKey HID+CDC"
board_build.usb_manufacturer = "NW-Lab"
board_build.sdkconfig_defaults = sdkconfig.defaults

; デバッグ設定
debug_tool = esp-builtin
debug_init_break = tbreak setup

; =============================
; 追加: ビルド後に生成バイナリを firmware/ へコピー
; export_firmware.py を post スクリプトとして実行
; =============================
extra_scripts = 
    post:export_firmware.py